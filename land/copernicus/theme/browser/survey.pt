<!--
  To enable the survey, in site/manage_propertiesForm:
    add Name: show_survey
        Type: boolean
    then check the checkbox and Save Changes.

  chrome://settings/siteData - for debug
-->

<!-- Satisfaction survey pop-up -->
<div tal:define="survey_url python:view.survey_url;
                 survey_delay python:getattr(context, 'survey_delay', 2000);
                 survey_delay_pageviews python:getattr(context, 'survey_delay_pageviews', 3)"
     id="land-survey"
     tal:condition="python:getattr(context, 'show_survey', None) is True">

  <script tal:content="string:var survey_url='${survey_url}';"></script>
  <script tal:content="string:var survey_delay='${survey_delay}';"></script>
  <script tal:content="string:var survey_delay_pageviews='${survey_delay_pageviews}';"></script>

  <script src="./sweetalert2.min.js"></script>
  <link rel="stylesheet" href="./sweetalert2.min.css">

  <script type="text/javascript">
    function survey_behaviour() {
      $(document).ready(function($) {

        var survey_title = "We value your opinion!";
        var survey_text = "Would you be willing to spend 4-5 min to provide your feedback on our website?";

        if(!localStorage.getItem("survey_answered")) {
          var pageviews = (+localStorage.getItem("page_views") || 0) + 1;
          localStorage.setItem("page_views", pageviews);

          if(pageviews >= survey_delay_pageviews) {
            setTimeout(function() {
              swal({
                title: survey_title,
                text: survey_text,
                type: "success",
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes',
                cancelButtonText: 'No',
              }).then((result) => {
                localStorage.setItem("survey_answered", "true");
                window.location.replace(survey_url);
              }).catch(() => {
                localStorage.setItem("survey_answered", "true");
              });
            }, survey_delay);
          }
        }
      });
    }

    if(window.jQuery) {
      survey_behaviour();
    } // TODO: else? load it? investigate this in homepage.
  </script>
</div>
